<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verification Result</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { background-color: #e9ecef; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .card-result { max-width: 450px; width: 100%; border: none; border-radius: 20px; box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
        .loader-ring { width: 3rem; height: 3rem; border-width: 0.25em; }
    </style>
</head>
<body>

    <div class="card card-result p-4 text-center">
        
        <div id="state-loading">
            <div class="spinner-border text-primary loader-ring mb-3" role="status"></div>
            <h5 class="fw-bold">Securing Connection...</h5>
            <p class="text-muted small">Validating security parameters.</p>
            <p class="text-muted small mb-0">
                Total Visitors: <span id="visitor-count-verify">Loading...</span>
            </p>
        </div>

        <div id="state-success" class="d-none">
            <div class="mb-3">
                <i class="bi bi-shield-fill-check text-success" style="font-size: 4rem;"></i>
            </div>
            <h4 class="fw-bold text-success">Access Granted!</h4>
            <p class="text-muted small mb-4">Security checks passed. Redirecting...</p>
            
            <div class="bg-light p-3 rounded mb-3 border border-success">
                <small class="text-muted fw-bold d-block mb-1">YOUR TOKEN:</small>
                <code id="token-text" class="fs-4 fw-bold text-dark">---</code>
            </div>

            <div class="d-grid gap-2">
                <a id="btn-deep-link" href="#" class="btn btn-primary btn-lg rounded-pill shadow">
                    Open App Automatically
                </a>
            </div>
        </div>

        <div id="state-error" class="d-none">
            <div class="mb-3">
                <i class="bi bi-shield-x text-danger" style="font-size: 4rem;"></i>
            </div>
            <h5 class="fw-bold text-danger">Access Denied</h5>
            <p class="text-muted small mb-4" id="error-msg">
                Invalid verification attempt.
            </p>
            <a href="token.html" class="btn btn-outline-danger rounded-pill px-4">Try Again</a>
        </div>

    </div>

    <script>
        // --- KONFIGURASI KEAMANAN ---
        const MIN_SECONDS = 15;
        const SECRET_KEY = "KuroyamaMLBoosterV45NEW";

        const stateLoading = document.getElementById('state-loading');
        const stateSuccess = document.getElementById('state-success');
        const stateError = document.getElementById('state-error');
        const errorMsg = document.getElementById('error-msg');
        const tokenText = document.getElementById('token-text');
        const btnDeepLink = document.getElementById('btn-deep-link');

        function generateToken() {
            const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
            let result = "KYO-";
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        window.onload = function() {
            const startTime = localStorage.getItem('auth_session_start');
            const urlParams = new URLSearchParams(window.location.search);
            const authParam = urlParams.get('auth_key');

            setTimeout(() => {
                stateLoading.classList.add('d-none');

                if (authParam !== SECRET_KEY) {
                    errorMsg.innerHTML = "Invalid Source URL.<br>You must complete the shortlink process.";
                    stateError.classList.remove('d-none');
                    return;
                }

                if (!startTime) {
                    errorMsg.innerHTML = "Session not found.<br>Please start from the beginning.";
                    stateError.classList.remove('d-none');
                    return;
                }

                const currentTime = Date.now();
                const duration = (currentTime - parseInt(startTime)) / 1000;
                
                console.log("Validation Time: " + duration + "s");

                if (duration < MIN_SECONDS) {
                    errorMsg.innerHTML = "Suspicious activity detected.<br>Completion time too fast.";
                    stateError.classList.remove('d-none');
                } else {
                    const finalToken = generateToken();
                    tokenText.textContent = finalToken;
                    
                    const deepLinkUrl = "myapp://verify?token=" + finalToken;
                    btnDeepLink.href = deepLinkUrl;
                    
                    stateSuccess.classList.remove('d-none');
                    localStorage.removeItem('auth_session_start');

                    setTimeout(() => {
                        window.location.href = deepLinkUrl;
                    }, 1500);
                }
            }, 1500);
        };
    </script>

    <!-- Visitor Counter -->
    <script>
        (function () {
            const domain = window.location.hostname;
            fetch('https://visitor.6developer.com/visit?domain=' + encodeURIComponent(domain))
                .then(response => response.json())
                .then(data => {
                    document.getElementById('visitor-count-verify').textContent = data.totalCount;
                })
                .catch(() => {
                    document.getElementById('visitor-count-verify').textContent = 'Error';
                });
        })();
    </script>

    <!-- Proteksi ringan -->
    <script>
        document.addEventListener("contextmenu", function(e) {
            e.preventDefault();
        });
        document.addEventListener("keydown", function(e) {
            if (e.key === "F12" || (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "J" || e.key === "C"))) {
                e.preventDefault();
            }
        });
    </script>
</body>
</html>
