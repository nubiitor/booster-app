<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verification Result</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { background-color: #e9ecef; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .card-result { max-width: 450px; width: 100%; border: none; border-radius: 20px; box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
        .loader-ring { width: 3rem; height: 3rem; border-width: 0.25em; }
    </style>
</head>
<body>

    <div class="card card-result p-4 text-center">
        
        <div id="state-loading">
            <div class="spinner-border text-primary loader-ring mb-3" role="status"></div>
            <h5 class="fw-bold">Checking Validation...</h5>
            <p class="text-muted small">Please wait while we verify your session.</p>
        </div>

        <div id="state-success" class="d-none">
            <div class="mb-3">
                <i class="bi bi-patch-check-fill text-success" style="font-size: 4rem;"></i>
            </div>
            <h4 class="fw-bold text-success">Verified!</h4>
            <p class="text-muted small mb-4">Your access token is ready.</p>
            
            <div class="bg-light p-3 rounded mb-3 border border-success">
                <small class="text-muted fw-bold d-block mb-1">YOUR TOKEN:</small>
                <code id="token-text" class="fs-4 fw-bold text-dark">---</code>
            </div>

            <div class="d-grid gap-2">
                <a id="btn-deep-link" href="#" class="btn btn-primary btn-lg rounded-pill shadow">
                    Open App Automatically
                </a>
            </div>
        </div>

        <div id="state-error" class="d-none">
            <div class="mb-3">
                <i class="bi bi-x-octagon-fill text-danger" style="font-size: 4rem;"></i>
            </div>
            <h5 class="fw-bold text-danger">Verification Failed</h5>
            <p class="text-muted small mb-4">
                You arrived here too quickly or without starting the process properly.
            </p>
            <a href="token.html" class="btn btn-outline-danger rounded-pill px-4">Try Again</a>
        </div>

    </div>

    <script>
        // --- KONFIGURASI WAKTU ---
        const MIN_SECONDS = 15; // Minimal waktu (detik) user harus di shortlink
        
        // Elemen DOM
        const stateLoading = document.getElementById('state-loading');
        const stateSuccess = document.getElementById('state-success');
        const stateError = document.getElementById('state-error');
        const tokenText = document.getElementById('token-text');
        const btnDeepLink = document.getElementById('btn-deep-link');

        // Fungsi Generate Token
        function generateToken() {
            const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
            let result = "KYO-";
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        window.onload = function() {
            // 1. Ambil waktu mulai dari memori
            const startTime = localStorage.getItem('auth_session_start');
            
            // Simulasi loading sebentar biar terlihat prosesnya
            setTimeout(() => {
                stateLoading.classList.add('d-none');

                // Validasi 1: Apakah user pernah klik tombol Start di token.html?
                if (!startTime) {
                    stateError.classList.remove('d-none');
                    return;
                }

                // Validasi 2: Hitung durasi
                const currentTime = Date.now();
                const duration = (currentTime - parseInt(startTime)) / 1000; // dalam detik
                
                console.log("Durasi user: " + duration + " detik");

                if (duration < MIN_SECONDS) {
                    // JIKA TERLALU CEPAT (Bypass/Langsung paste link)
                    stateError.classList.remove('d-none');
                } else {
                    // JIKA LOLOS VALIDASI
                    const finalToken = generateToken();
                    
                    // Tampilkan Token
                    tokenText.textContent = finalToken;
                    
                    // Set Deep Link
                    const deepLinkUrl = "myapp://verify?token=" + finalToken;
                    btnDeepLink.href = deepLinkUrl;
                    
                    stateSuccess.classList.remove('d-none');

                    // Hapus sesi agar tidak bisa direfresh untuk dapet token baru
                    localStorage.removeItem('auth_session_start');

                    // Otomatis buka aplikasi setelah 1.5 detik
                    setTimeout(() => {
                        window.location.href = deepLinkUrl;
                    }, 1500);
                }
            }, 1000);
        };
    </script>
</body>
</html>
